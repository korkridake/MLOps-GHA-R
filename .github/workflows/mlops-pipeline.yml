name: MLOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'
    
    - name: Setup R dependencies
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        cache-version: 1
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
    
    - name: Install R packages
      run: |
        install.packages(c("mlflow", "tidyverse", "caret", "randomForest", "carrier"))
      shell: Rscript {0}
    
    - name: Run data preparation
      run: Rscript src/data/make_dataset.R
    
    - name: Train model with MLflow
      run: Rscript src/models/train_model.R
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
    
    - name: Make predictions
      run: Rscript src/models/predict_model.R
    
    - name: Generate visualizations
      run: Rscript src/visualization/visualize.R
    
    - name: Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: trained-model
        path: models/
    
    - name: Upload visualizations
      uses: actions/upload-artifact@v3
      with:
        name: visualizations
        path: reports/figures/
    
    - name: Upload MLflow runs
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-runs
        path: mlruns/
